name: CI/CD  with terraform

on:
  :
    branches:
      - Complete-CI/CD-with-terraform-aws
 env: 
    AWS_ACCESS_KEY_ID= ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY= ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    TF_STATE_BUCKET_NAME= {{ secrets.AWS_TF_STATE_BUCKET_NAME }}
    PRIVATE_SSH_KEY= {{ secrets.AWS_SSH_KEY_PRIVATE }}
    PUBLIC_SSH_KEY= {{ secrets.AWS_SSH_KEY_PUBLIC }}
    AWS_REGION= us-west-2
    
jobs:
  deploy-infra:
    runs-on: ubuntu-latest
    steps:
        -name: checkout
        uses: actions/checkout@v2
        -name: setup terraform
        uses: hashicorp/setup-terraform@v1
        with:
            terraform_wrapper:false
        -name: terraform init
        id: init
        run: terraform init -backend-config="bucket=$TF_STATE_BUCKET_NAME" -backend-config"region=us-west-2"
        workingdirectory: ./terraform
        -name: terraform plan
        id: plan
        run: |-
            terraform plan \
            -var="region=us-west2" \
            -var="public_key=$PUBLIC_SSH_KEY" \
            -var="private_key=$PRIVATE_SSH_KEY" \
            -var="key_name=deployer_key" \
            -out= PLAN
        -name: Terraform Apply
        id: apply
        run: terraform apply PLAN
        workingdirectory: ./terraform

